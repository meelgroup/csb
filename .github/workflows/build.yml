name: build

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ "*" ]

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false

      matrix:
        include:
          - os: ubuntu-latest
            build_type: Release
            staticcompile: 'ON'
          - os: ubuntu-24.04-arm
            build_type: Release
            staticcompile: 'ON'
          - os: macos-14
            build_type: Release
            staticcompile: 'OFF'
          - os: macos-13
            build_type: Release
            staticcompile: 'OFF'

    steps:
    - uses: actions/setup-python@v5
      if: ${{ !contains(matrix.os, 'macos') }}
      with:
        python-version: '3.10'

    - name: Install dependencies for Linux
      if: contains(matrix.os, 'ubuntu')
      run: |
        sudo apt-get update
        sudo apt-get install -yq git cmake bison flex libboost-all-dev python3 perl \
          build-essential python3-distutils-extra wget zlib1g-dev \
          libboost-program-options-dev libboost-serialization-dev \
          libgmp-dev libmpfr-dev help2man

    - name: Install dependencies for macOS
      if: contains(matrix.os, 'macos')
      run: |
        brew update
        brew install bison cmake boost gmp mpfr wget zig
        MPFR_PREFIX=$(brew --prefix mpfr)
        GMP_PREFIX=$(brew --prefix gmp)
        BISON_PREFIX=$(brew --prefix bison)
        if [ -n "${CPPFLAGS:-}" ]; then
          echo "CPPFLAGS=${CPPFLAGS} -I${MPFR_PREFIX}/include -I${GMP_PREFIX}/include" >> "$GITHUB_ENV"
        else
          echo "CPPFLAGS=-I${MPFR_PREFIX}/include -I${GMP_PREFIX}/include" >> "$GITHUB_ENV"
        fi
        if [ -n "${CXXFLAGS:-}" ]; then
          echo "CXXFLAGS=${CXXFLAGS} -I${MPFR_PREFIX}/include -I${GMP_PREFIX}/include" >> "$GITHUB_ENV"
        else
          echo "CXXFLAGS=-I${MPFR_PREFIX}/include -I${GMP_PREFIX}/include" >> "$GITHUB_ENV"
        fi
        if [ -n "${CFLAGS:-}" ]; then
          echo "CFLAGS=${CFLAGS} -I${MPFR_PREFIX}/include -I${GMP_PREFIX}/include" >> "$GITHUB_ENV"
        else
          echo "CFLAGS=-I${MPFR_PREFIX}/include -I${GMP_PREFIX}/include" >> "$GITHUB_ENV"
        fi
        if [ -n "${LDFLAGS:-}" ]; then
          echo "LDFLAGS=${LDFLAGS} -L${MPFR_PREFIX}/lib -L${GMP_PREFIX}/lib -lmpfr -lgmp" >> "$GITHUB_ENV"
        else
          echo "LDFLAGS=-L${MPFR_PREFIX}/lib -L${GMP_PREFIX}/lib -lmpfr -lgmp" >> "$GITHUB_ENV"
        fi
        echo "PATH=${BISON_PREFIX}/bin:${PATH}" >> "$GITHUB_ENV"
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: 'false'

    - name: Initialize submodules
      run: git submodule update --init

    - name: Configure
      run: cmake -S . -B build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}

    - name: Build
      run: cmake --build build -- -j20

    - name: Verify weighted example output
      run: |
        set -euo pipefail
        ./build/csb -c tests/examples/weighted.smt2 | tee csb_weighted.log
        grep -F "c [stp] using KCBox counting backend" csb_weighted.log
        grep -F "c s log10-estimate 1.13861843e+00" csb_weighted.log
        grep -F "c o exact quadruple float 1.37600000e+01" csb_weighted.log

    - name: Upload Artifact - Linux
      if: ${{ contains(matrix.os, 'ubuntu') && matrix.staticcompile == 'ON' && !contains(matrix.os, 'arm') }}
      uses: actions/upload-artifact@v4
      with:
        name: csb-linux-amd64
        path: build/csb

    - name: Upload Artifact - Linux arm
      if: contains(matrix.os, 'ubuntu') && matrix.staticcompile == 'ON' && contains(matrix.os, 'arm')
      uses: actions/upload-artifact@v4
      with:
        name: csb-linux-arm64
        path: build/csb

    - name: Upload Artifact - Mac Intel
      if: matrix.os == 'macos-13' && matrix.staticcompile == 'ON'
      uses: actions/upload-artifact@v4
      with:
        name: csb-mac-x86_64
        path: build/csb

    - name: Upload Artifact - Mac Arm
      if: matrix.os == 'macos-14' && matrix.staticcompile == 'ON'
      uses: actions/upload-artifact@v4
      with:
        name: csb-mac-arm64
        path: build/csb

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && contains(github.event.head_commit.message, '[Release]')
    env:
      RELEASE_VERSION: 2.0.0
    steps:
    - name: Download Ubuntu Artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: csb-linux-*
        path: artifacts
    - name: Install release dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y binutils-aarch64-linux-gnu zip
    - name: Prepare release artifacts
      run: |
        set -euo pipefail
        AMD64_DIR="artifacts/csb-linux-amd64"
        ARM64_DIR="artifacts/csb-linux-arm64"
        strip "${AMD64_DIR}/csb"
        aarch64-linux-gnu-strip "${ARM64_DIR}/csb"
        (cd "${AMD64_DIR}" && rm -f ../csb-linux-amd64.zip && zip -j ../csb-linux-amd64.zip csb)
        (cd "${ARM64_DIR}" && rm -f ../csb-linux-arm64.zip && zip -j ../csb-linux-arm64.zip csb)
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ env.RELEASE_VERSION }}
        name: Release CSB v${{ env.RELEASE_VERSION }}
        files: |
          artifacts/csb-linux-amd64.zip
          artifacts/csb-linux-arm64.zip
